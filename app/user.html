<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<script src="script/vue.min.js"></script>
		<link href="style/style.css" rel="stylesheet" />
		<title>ðŸ“º Movie Time</title>

		<style>
			body {
				overflow-x: hidden !important;
				overflow-y: hidden !important;
				background-color: #3a3a44;
			}

			.content {
				width: 100%;
				height: 100vh;
				position: relative;
				overflow: hidden;
				/* overflow: scroll; */
			}

			.video-container {
				position: absolute;
				width: 100%;
				background: black;
				top: 0;
				left: 0;
				bottom: 107px;
				overflow: hidden;
			}

			#videoPlayer {
				height: 100%;
				width: 100%;
				outline: none;
				border: none;
			}
		</style>
	</head>
	<body>
		<div id="clientApp">
			<!-- header -->
			<div class="pv-1 ph-1 flex_center_vertical flex_space_between">
				<p class="text_small text_white">î©½ {{headers.fileName || "Load video file"}}</p>
				<p class="text_small text_white link">îª’ Settings</p>
			</div>
			{{chat}}
			<!-- content -->
			<div class="content">
				<div class="video-container">
					<video type="video/mp4" :src="`http://${urlParams.host}/${fileURL}`" id="videoPlayer" controls poster="" @play="playerPlay()" @pause="playerPause()" @stop="playerStop()"></video>
				</div>
			</div>
		</div>

		<script>
			new Vue({
				el: "#clientApp",
				data() {
					return {
						chat: [],
						videoPlayer: null,
						fileURL: null,
						headers: {},
						socket: {},
						urlParams: urlBreak(),
					};
				},
				mounted() {
					this.videoPlayer = document.getElementById("videoPlayer");
					setInterval(() => {
						if (!this.socket.readyState || this.socket.readyState !== 1) {
							console.log("websocket is closed! opening ....");
							this.socket = new WebSocket(`ws://${this.urlParams.hostname}:${this.urlParams.query.s}`);
							this.socket.onopen = (e) => this.socket.send(JSON.stringify({ about: "initMe" }));
							this.socket.onmessage = (e) => this.socketMSG(e);
						}
					}, 3000);
				},
				methods: {
					playerPlay() {
						clearTimeout(window.playerPlay);
						window.playerPlay = setTimeout(() => {
							this.videoPlayer.play();
							this.socket.send(JSON.stringify({ msg: "play", about: "player", currentTime: this.videoPlayer.currentTime }));
						}, 100);
					},
					playerPause() {
						clearTimeout(window.playerPlay);
						window.playerPlay = setTimeout(() => {
							this.videoPlayer.pause();
							this.socket.send(JSON.stringify({ msg: "pause", about: "player", currentTime: this.videoPlayer.currentTime }));
						}, 100);
					},
					socketMSG(socketData) {
						var e = JSON.parse(socketData.data);
						console.log(e);
						if (e.about == "initMe") {
							this.headers = e.msg;
							this.fileURL = e.msg.fileURL;
							this.chat = e.msg.chat;
						} else if (e.about == "player") {
							if (e.msg == "tick") {
								if (this.videoPlayer.paused) this.videoPlayer.currentTime = e.currentTime;
							}
							if (e.msg == "play") {
								if (e.fileURL && e.fileURL !== this.fileURL) {
									location.reload();
									// this.headers = this.getHeaders();
									// console.log(e);
									// this.fileURL = e.fileURL;
									// this.headers.fileName = e.fileName;
								}
								this.videoPlayer.currentTime = e.currentTime;
								this.videoPlayer.play();
							}
							if (e.msg == "pause") {
								this.videoPlayer.currentTime = e.currentTime;
								this.videoPlayer.pause();
							}
						} else if (e.about == "chat") {
							this.chat.push(e.msg);
						}
					},
				},
			});

			// ----- helpers -----
			function urlBreak() {
				var url = {};
				url.hostname = location.hostname;
				url.host = location.host;
				var q = location.search.substring(1);
				if (!q) return url;

				url.query = JSON.parse('{"' + decodeURI(q).replace(/"/g, '\\"').replace(/&/g, '","').replace(/=/g, '":"') + '"}');
				return url;
			}
		</script>
	</body>
</html>
